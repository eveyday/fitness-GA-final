<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¥èº«è¨“ç·´èœå–®ç”¢ç”Ÿå™¨</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-4">
  <div class="max-w-4xl mx-auto">
    <div class="text-center mb-6">
      <h1 class="text-3xl font-bold text-gray-800">å¥èº«è¨“ç·´èœå–®ç”¢ç”Ÿå™¨</h1>
      <p class="text-gray-600">æ ¹æ“šæ‚¨çš„è³‡æ–™ç”¢ç”Ÿå°ˆå±¬å¥èº«è¨ˆç•«</p>
    </div>

  <!-- ç¬¬ä¸€éšæ®µ -->
  <div id="step1" class="bg-white p-6 rounded shadow-md space-y-4">
    <h2 class="text-xl font-semibold text-blue-700">åŸºæœ¬è³‡æ–™è¼¸å…¥</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="block text-gray-700">å§“å</label>
        <input id="name" class="border w-full p-2 rounded" type="text">
        <p id="error-name" class="text-red-500 text-sm hidden error-msg">è«‹è¼¸å…¥å§“å</p>
      </div>
      <div>
        <label class="block text-gray-700">å¹´é½¡</label>
        <input id="age" class="border w-full p-2 rounded" type="number" min="1">
        <p id="error-age" class="text-red-500 text-sm hidden error-msg">è«‹è¼¸å…¥å¹´é½¡</p>
      </div>
      <div>
        <label class="block text-gray-700">èº«é«˜ (cm)</label>
        <input id="height" class="border w-full p-2 rounded" type="number" min="1">
        <p id="error-height" class="text-red-500 text-sm hidden error-msg">è«‹è¼¸å…¥èº«é«˜</p>
      </div>
      <div>
        <label class="block text-gray-700">é«”é‡ (kg)</label>
        <input id="weight" class="border w-full p-2 rounded" type="number" min="1">
        <p id="error-weight" class="text-red-500 text-sm hidden error-msg">è«‹è¼¸å…¥é«”é‡</p>
      </div>
    </div>

    <div>
      <label class="block text-gray-700">è¨“ç·´ç­‰ç´š</label>
      <select id="level" class="border w-full p-2 rounded">
        <option value="">-- è«‹é¸æ“‡ --</option>
        <option value="beginner">åˆå­¸è€…</option>
        <option value="intermediate">ä¸­éš</option>
        <option value="advanced">é€²éš</option>
      </select>
      <p id="error-level" class="text-red-500 text-sm hidden error-msg">è«‹é¸æ“‡è¨“ç·´ç­‰ç´š</p>
    </div>

    <div>
      <label class="block text-gray-700">è¨“ç·´ç›®æ¨™</label>
      <div class="flex gap-4 mt-1">
        <label><input type="radio" name="goal" value="muscle_gain"> å¢è‚Œ</label>
        <label><input type="radio" name="goal" value="fat_loss"> æ¸›è„‚</label>
      </div>
      <p id="error-goal" class="text-red-500 text-sm hidden error-msg">è«‹é¸æ“‡è¨“ç·´ç›®æ¨™</p>
    </div>
    <div>
      <label class="block text-gray-700">æ¬²åŠ å¼·è¨“ç·´éƒ¨ä½ï¼ˆé¸å¡«ï¼‰</label>
      <select id="target_muscles" class="border w-full p-2 rounded">
        <option value="">-- ç„¡ç‰¹åˆ¥åŠ å¼·éƒ¨ä½ --</option>
        <option value="èƒ¸">èƒ¸</option>
        <option value="èƒŒ">èƒŒ</option>
        <option value="è…¿">è…¿</option>
        <option value="æ‰‹è‡‚">æ‰‹è‡‚</option>
        <option value="è‚©">è‚©</option>
        <option value="è‡€">è‡€</option>
      </select>
    </div>
    <div>
      <label class="block text-gray-700">æ¯é€±è¨“ç·´æ—¥ (è¤‡é¸)</label>
      <div class="grid grid-cols-4 gap-2">
        <label><input type="checkbox" value="Day1" class="training-day"> æ˜ŸæœŸä¸€</label>
        <label><input type="checkbox" value="Day2" class="training-day"> æ˜ŸæœŸäºŒ</label>
        <label><input type="checkbox" value="Day3" class="training-day"> æ˜ŸæœŸä¸‰</label>
        <label><input type="checkbox" value="Day4" class="training-day"> æ˜ŸæœŸå››</label>
        <label><input type="checkbox" value="Day5" class="training-day"> æ˜ŸæœŸäº”</label>
        <label><input type="checkbox" value="Day6" class="training-day"> æ˜ŸæœŸå…­</label>
        <label><input type="checkbox" value="Day7" class="training-day"> æ˜ŸæœŸå¤©</label>
      </div>
      <p id="error-days" class="text-red-500 text-sm hidden error-msg">è«‹é¸æ“‡ 3~5 å¤©çš„è¨“ç·´æ—¥</p>
    </div>

    <button onclick="nextStep()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded">ä¸‹ä¸€æ­¥</button>
  </div>
  <!-- ç¬¬äºŒéšæ®µ -->
  <div id="step2" class="hidden bg-white p-6 mt-6 rounded shadow-md space-y-4">
    <h2 class="text-xl font-semibold text-green-700">è¼¸å…¥ä»£è¡¨æ€§å‹•ä½œé‡é‡èˆ‡æ¬¡æ•¸</h2>

    <div class="overflow-x-auto">
      <table class="table-auto w-full border">
        <thead>
          <tr class="bg-gray-100">
            <th class="px-2 py-1 border">å‹•ä½œåç¨±</th>
            <th class="px-2 py-1 border">é‡é‡ (kg)</th>
            <th class="px-2 py-1 border">æ¬¡æ•¸</th>
          </tr>
        </thead>
        <tbody id="exercise-table"></tbody>
      </table>
    </div>

    <div class="mt-4 p-4 bg-yellow-100 text-yellow-800 rounded border border-yellow-300">
      <p class="font-semibold">ğŸ”” åˆå­¸è€…å°æé†’ï¼š</p>
      <p>è‹¥æ‚¨ä¸ç¢ºå®šè‡ªå·±çš„è¨“ç·´é‡é‡ï¼Œå»ºè­°ä½¿ç”¨ä¸€å€‹åœ¨ç¬¬ 10 æ¬¡è¦ºå¾—æœ‰æŒ‘æˆ°æ€§ã€ä½†ä»èƒ½å‹‰å¼·å®Œæˆ 12 æ¬¡çš„é‡é‡ã€‚</p>
    </div>

    <button onclick="prevStep()" class="bg-gray-400 text-white px-4 py-2 rounded mr-2">ä¸Šä¸€æ­¥</button>
    <button onclick="submitForm()" class="bg-green-600 text-white px-4 py-2 rounded">ç”¢ç”Ÿè¨“ç·´èœå–®</button>
    <a href="/fitness-result" class="bg-purple-600 text-white px-4 py-2 rounded mt-4 inline-block">æŸ¥çœ‹åˆ†æçµæœ</a>
  </div>

    <!-- çµæœé¡¯ç¤ºå€ -->
    <div id="result" class="hidden mt-8 bg-white p-6 rounded shadow-md">
      <h2 class="text-xl font-semibold text-orange-700 mb-4">æ‚¨çš„å°ˆå±¬è¨“ç·´èœå–®</h2>

      <!-- â¬‡â¬‡ è‚Œç¾¤æ¸…å–®é¡¯ç¤ºä½ç½® -->
      <ul id="muscle-schedule" class="list-disc ml-6 text-blue-600 mb-4"></ul>

      <div id="plan-content" class="space-y-4"></div>
    </div>
  
  <script>
    const exercises = [
      'è…¿æ¨', 'è‡€æ¨', 'èƒ¸æ¨', 'æ§“éˆ´è‚©æ¨', 'å•éˆ´å´å¹³èˆ‰', 'ä¿¯èº«é£›é³¥ï¼ˆå•éˆ´ï¼‰',
      'é«˜ä½ä¸‹æ‹‰', 'é›†ä¸­å½èˆ‰', 'æ–œæ¿å½èˆ‰', 'ç¹©ç´¢ä¸‹å£“', 'æ©Ÿæ¢°å¼æ²è…¹'
    ];

    let globalUserData = {}; 

    const tableBody = document.getElementById("exercise-table");
    exercises.forEach(name => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td class="border px-2 py-1">${name}</td>
        <td class="border px-2 py-1"><input class="border w-full p-1" type="number" name="${name}-weight"></td>
        <td class="border px-2 py-1"><input class="border w-full p-1" type="number" name="${name}-reps"></td>
      `;
      tableBody.appendChild(row);
    });

    function nextStep() {
      const name = document.getElementById('name').value.trim();
      const age = Number(document.getElementById('age').value);
      const height = Number(document.getElementById('height').value);
      const weight = Number(document.getElementById('weight').value);
      const level = document.getElementById('level').value;
      const goal = document.querySelector('input[name="goal"]:checked')?.value || '';
      const trainingDays = [...document.querySelectorAll('.training-day:checked')].map(cb => cb.value);
      const selectedTargets = document.getElementById("target_muscles").value;
      const targetMuscles = selectedTargets ? [selectedTargets] : [];

      // æ¸…é™¤éŒ¯èª¤æç¤º
      document.querySelectorAll('.error-msg').forEach(el => el.classList.add('hidden'));

      let hasError = false;
      if (!name) { document.getElementById('error-name').classList.remove('hidden'); hasError = true; }
      if (!age || age < 1) { document.getElementById('error-age').classList.remove('hidden'); hasError = true; }
      if (!height || height < 1) { document.getElementById('error-height').classList.remove('hidden'); hasError = true; }
      if (!weight || weight < 1) { document.getElementById('error-weight').classList.remove('hidden'); hasError = true; }
      if (!level) { document.getElementById('error-level').classList.remove('hidden'); hasError = true; }
      if (!goal) { document.getElementById('error-goal').classList.remove('hidden'); hasError = true; }
      if (trainingDays.length < 3 || trainingDays.length > 5) {
        document.getElementById('error-days').classList.remove('hidden'); hasError = true;
      }

      if (hasError) return;

      globalUserData = {
        name, age, height, weight, level, goal,
        training_days_list: trainingDays,
        target_muscles: targetMuscles
      };

      document.getElementById('step1').classList.add('hidden');
      document.getElementById('step2').classList.remove('hidden');
    }



    async function submitForm() {
      let hasExerciseError = false;
      const exerciseErrors = [];

      const exercisesFilled = exercises.map(name => {
        const weightInput = document.querySelector(`input[name='${name}-weight']`);
        const repsInput = document.querySelector(`input[name='${name}-reps']`);
        const weight = Number(weightInput.value);
        const reps = Number(repsInput.value);

        if (!weight || weight <= 0) {
          weightInput.classList.add("border-red-500");
          hasExerciseError = true;
          exerciseErrors.push(`${name} çš„é‡é‡`);
        } else {
          weightInput.classList.remove("border-red-500");
        }

        if (!reps || reps <= 0) {
          repsInput.classList.add("border-red-500");
          hasExerciseError = true;
          exerciseErrors.push(`${name} çš„æ¬¡æ•¸`);
        } else {
          repsInput.classList.remove("border-red-500");
        }

        return { name, weight, reps };
      });

      if (hasExerciseError) {
        alert("è«‹å®Œæ•´å¡«å¯«ä»¥ä¸‹æ¬„ä½ï¼š\n" + exerciseErrors.join("\n"));
        return;
      }

      const payload = {
        userData: globalUserData,
        exercises: exercisesFilled
      };

      const res = await fetch('/generate-plan', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const result = await res.json();
      showResult(result);
      }

  function showResult(data) {
  const resultDiv = document.getElementById('result');
  const content = document.getElementById('plan-content');
  const muscleList = document.getElementById('muscle-schedule'); // â† ä¿®æ­£ï¼šåŠ å…¥è‚Œç¾¤æ¸…å–® DOM

  resultDiv.classList.remove('hidden');
  content.innerHTML = '';
  muscleList.innerHTML = ''; // â† æ¯æ¬¡é‡ç®—å‰å…ˆæ¸…ç©ºè‚Œç¾¤æ¸…å–®

  const dayMap = {
    Day1: "æ˜ŸæœŸä¸€", Day2: "æ˜ŸæœŸäºŒ", Day3: "æ˜ŸæœŸä¸‰",
    Day4: "æ˜ŸæœŸå››", Day5: "æ˜ŸæœŸäº”", Day6: "æ˜ŸæœŸå…­", Day7: "æ˜ŸæœŸæ—¥"
  };

  // åŠ å…¥æ¯æ—¥è‚Œç¾¤åˆ†é…æ¸…å–®
  if (data.muscle_schedule) {
    for (const [day, muscles] of Object.entries(data.muscle_schedule)) {
      const li = document.createElement('li');
      const chineseDay = dayMap[day] || day;
      li.textContent = `${chineseDay}ï¼š${muscles.join('ã€')}`;
      muscleList.appendChild(li);
    }
  }

  // ä¾ç…§æ˜ŸæœŸé †åºæ’åºä¸¦ç”¢ç”Ÿæ¯ä¸€å¤©çš„è¨“ç·´è¨ˆç•«
  data.week.sort((a, b) => {
    const numA = parseInt(a.day.replace("Day", ""));
    const numB = parseInt(b.day.replace("Day", ""));
    return numA - numB;
  });

  data.week.forEach(day => {
    const dayBlock = document.createElement('div');
    dayBlock.className = 'bg-white p-6 rounded-xl shadow-md';

    const chineseDay = dayMap[day.day] || day.day;
    const title = `<h3 class="text-xl font-semibold text-blue-700 mb-3">${chineseDay}</h3>`;

    const listItems = day.exercises.map(e =>
      `<li class="ml-5 list-disc text-gray-700">
        ${e.name}ï½œå¤§è‚Œç¾¤ï¼š${e.major}ï¼Œç´°é …ï¼š${e.minor}<br>
        ${e.sets} çµ„ * ${e.reps} æ¬¡ï¼Œä¼‘æ¯ ${e.rest} ç§’ï¼Œé‡é‡ï¼š${e.weight} kgï¼Œå±éšªåº¦:${e.risk}
      </li>`
    ).join('');

    const list = `<ul class="space-y-2">${listItems}</ul>`;
    dayBlock.innerHTML = title + list;
    content.appendChild(dayBlock);
    });
  }
  </script>
</body>
</html>
